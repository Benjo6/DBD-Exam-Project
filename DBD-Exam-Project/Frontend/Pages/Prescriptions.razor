@page "/prescriptions"

<PageTitle>Prescriptions</PageTitle>

@inject UserProvider UserProvider
@inject IPrescriptionService PrescriptionService

<h3>Prescriptions</h3>

<Tabs>
    @if(_currentUser.Type != PersonType.Pharmaceut)
    {
        <TabPane Tab="See own prescriptions">
            <PrescriptionTable Prescriptions="_prescriptionsData" PeopleType="_currentUser.Type"/>
        </TabPane>
    }
    @if (_currentUser.Type != PersonType.Patient)
    {
        <TabPane Tab="Search for patient prescriptions">
            <Space>
                <Search Placeholder="input person cpr number" EnterButton="@("Find")" OnSearch="OnSearchForPrescriptions">
                    <Prefix>
                        <Icon Type="User"/>
                    </Prefix>
                </Search>
            </Space>
            <br/>
            <PrescriptionTable Prescriptions="_prescriptionSearchResult" PeopleType="_currentUser.Type"/>
        </TabPane>
    }
</Tabs>



<Tabs>
    @if (UserProvider.CurrentUser.Type == PersonType.Doctor)
    {
        <TabPane Tab="Create prescription">
           
        </TabPane>
    }
    else if (UserProvider.CurrentUser.Type == PersonType.Patient)
    {
        <TabPane Tab="See your prescriptions">
             @if (patientPersonalPrescriptions != null)
            {
                <Table TItem="PrescriptionDto" DataSource="@patientPersonalPrescriptions">
                    <Column Title="Medicine" @bind-Field="@context.MedicineName" />
                    <Column Title="Prescribed by" @bind-Field="@context.Doctor" />
                    <Column Title="Expiration date" @bind-Field="@context.Expiration" />
                </Table>
            }
        </TabPane>
    }
    else if (UserProvider.CurrentUser.Type == PersonType.Pharmaceut)
    {
        <TabPane Tab="Fulfill prescription">
        </TabPane>
    }
    @if (UserProvider.CurrentUser != null && UserProvider.CurrentUser.Type != PersonType.Patient)
    {
        <TabPane Tab="Find patient">
        </TabPane>
    }
</Tabs>

@code {
    IEnumerable<PrescriptionDto>? patientPersonalPrescriptions;
    IEnumerable<PrescriptionDto> _prescriptionsData = null!;
    IEnumerable<PrescriptionDto>? _prescriptionSearchResult;
    PersonDto _currentUser = null!;

    private async Task RequestPatientPrescriptions()
    {
        patientPersonalPrescriptions = await PrescriptionService.GetPrescriptionsForPatient(UserProvider.CurrentUser.CprNumber);
    }

    protected override async Task OnInitializedAsync()
    {
        if (UserProvider.CurrentUser?.Type == PersonType.Patient)
        {
            //await RequestPatientPrescriptions();
        }

        _currentUser = UserProvider.CurrentUser ?? new();
        UserProvider.OnUserChanged += OnUserChanged;

        _prescriptionsData = _currentUser.Type switch
        {
            PersonType.Doctor => await PrescriptionService.GetPrescriptionsForDoctor(_currentUser.Id),
            PersonType.Patient => await PrescriptionService.GetPrescriptionsForPatient(_currentUser.CprNumber!),
            _ => Enumerable.Empty<PrescriptionDto>()
        };
    }

    async Task OnSearchForPrescriptions(string query)
    {
        if (string.IsNullOrWhiteSpace(query))
            return;
        _prescriptionSearchResult = await PrescriptionService.GetPrescriptionsForPatient(query);
    }

    void OnUserChanged(object? obj, EventArgs arg)
    {
        _currentUser = UserProvider.CurrentUser!;
        StateHasChanged();
    }
}
